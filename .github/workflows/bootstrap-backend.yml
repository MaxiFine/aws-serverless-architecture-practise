name: Bootstrap Terraform Backend

on:
  workflow_dispatch:
    inputs:
      aws-region:
        description: AWS region for the backend bucket and lock table
        required: true
        default: eu-west-1
      bucket-name:
        description: Globally-unique S3 bucket name for Terraform state
        required: true
        default: learning-bucket-terraform-state
      lock-table-name:
        description: DynamoDB table name for Terraform state locking
        required: true
        default: terraform-state-locks

jobs:
  bootstrap:
    runs-on: ubuntu-latest
    permissions:
      id-token: write   # for GitHub OIDC
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ github.event.inputs["aws-region"] || 'eu-west-1' }}

      - name: Bootstrap S3 backend and DynamoDB lock table
        env:
          AWS_REGION: ${{ github.event.inputs["aws-region"] }}
          BUCKET_NAME: ${{ github.event.inputs["bucket-name"] }}
          TABLE_NAME: ${{ github.event.inputs["lock-table-name"] }}
        run: |
          set -euo pipefail
          echo "Region: $AWS_REGION"
          echo "Bucket: $BUCKET_NAME"
          echo "Lock Table: $TABLE_NAME"

          # Create bucket if missing
          if aws s3api head-bucket --bucket "$BUCKET_NAME" 2>/dev/null; then
            echo "Bucket exists: $BUCKET_NAME"
          else
            echo "Creating bucket: $BUCKET_NAME"
            aws s3api create-bucket \
              --bucket "$BUCKET_NAME" \
              --region "$AWS_REGION" \
              --create-bucket-configuration LocationConstraint="$AWS_REGION"
          fi

          # Enable bucket versioning
          aws s3api put-bucket-versioning --bucket "$BUCKET_NAME" --versioning-configuration Status=Enabled

          # Block public access
          aws s3api put-public-access-block \
            --bucket "$BUCKET_NAME" \
            --public-access-block-configuration 'BlockPublicAcls=true,IgnorePublicAcls=true,BlockPublicPolicy=true,RestrictPublicBuckets=true'

          # Default SSE (AES256)
          aws s3api put-bucket-encryption \
            --bucket "$BUCKET_NAME" \
            --server-side-encryption-configuration '{"Rules":[{"ApplyServerSideEncryptionByDefault":{"SSEAlgorithm":"AES256"}}]}'

          # Create DynamoDB lock table if missing
          if aws dynamodb describe-table --table-name "$TABLE_NAME" >/dev/null 2>&1; then
            echo "DynamoDB table exists: $TABLE_NAME"
          else
            echo "Creating DynamoDB lock table: $TABLE_NAME"
            aws dynamodb create-table \
              --table-name "$TABLE_NAME" \
              --attribute-definitions AttributeName=LockID,AttributeType=S \
              --key-schema AttributeName=LockID,KeyType=HASH \
              --billing-mode PAY_PER_REQUEST
            echo "Waiting for table to become ACTIVE..."
            aws dynamodb wait table-exists --table-name "$TABLE_NAME"
          fi

          echo "Bootstrap complete."

      - name: Reminder
        run: |
          echo "Update your Terraform backend configuration to use:"
          echo "  bucket        = \"${{ github.event.inputs["bucket-name"] }}\""
          echo "  key           = \"web-app-serverless/terraform.tfstate\""
          echo "  region        = \"${{ github.event.inputs["aws-region"] }}\""
          echo "  dynamodb_table = \"${{ github.event.inputs["lock-table-name"] }}\""

        